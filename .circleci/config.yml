# CircleCI 2.1 configuration file
#
#
version: 2.1
executors:
  womtool-executor:
    docker:
      # specify the version you desire here
      - image: broadinstitute/womtool:71
        entrypoint: /bin/bash
    working_directory: ~/palantir-workflows
    environment: WOMTOOL_JAR=/app/womtool.jar

orbs:
  python: circleci/python@2.1.1

commands:
  get-cromwell-jar:
    description: "Download cromwell jar"
    steps:
      - run: wget https://github.com/broadinstitute/cromwell/releases/download/71/cromwell-71.jar

  install-make:
    description: "Install make"
    steps:
      - run: |
            apt-get update
            apt-get install -y make
jobs:
  validate:
    executor: womtool-executor
    steps:
      - checkout
      - install-make
      - run: make validate

  validate-with-json:
    executor: womtool-executor
    steps:
      - checkout
      - install-make
      - run: make validate-with-json

  test:
    machine: true
    environment:
      CROMWELL_JAR=/home/circleci/project/cromwell-71.jar
    steps:
      - checkout
      - get-cromwell-jar
      - run: make test
      - store_artifacts:
          path: /home/circleci/project/logs
      - store_artifacts:
          path: /home/circleci/project/workflow_logs
      - store_artifacts:
          path: /home/circleci/project/call_logs

  python-3_7-tests:
    executor:
      name: python/default
      tag: "3.7"
    steps:
      - checkout
      - run: pip install ImputationPipeline/ManualQCPRS/
      - run: pip install ImputationPipeline/CreateAggregationSets/
      - run: python -m unittest discover -p "*Test.py"

workflows:
  version: 2
  validate-and-test:
    jobs:
      - validate
      - validate-with-json
      - test:
          requires:
            - validate
            - validate-with-json
  python-tests:
    jobs:
      - python-3_7-tests
  python/test:
    version: "3.7"
    pkg-manager: poetry
    args: ImputationPipeline/ManualQCPRS/
    test-tool-args: -p "*Test.py"