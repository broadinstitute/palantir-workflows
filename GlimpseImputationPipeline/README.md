# GLIMPSE Imputation Pipeline

This pipeline performs imputation using the [GLIMPSE2 software](https://github.com/odelaneau/GLIMPSE) by Simone Rubinacci et al. [\[1\]](https://www.biorxiv.org/content/10.1101/2022.11.28.518213v1) [\[2\]](https://www.nature.com/articles/s41588-020-00756-0).

This directory contains two WDLs: `Glimpse2SplitReference.wdl` and `Glimpse2Imputation.wdl`.

## Glimpse2SplitReference

This workflow splits the provided reference panel into a series of chunks that each span a specified region of the genome, and converts the reference panel into a binary representation that can be ingested by the `Glimpse2Imputation` workflow. This significantly speeds up the imputation process since this step only has to be performed once per reference panel instead of once per sample.

**Note on chunk sizes:** The choice of the chunk size is a trade-off between runtime per chunk and number of chunks (and therefore number of parallel jobs to be started). For imputation of single samples we would want to choose a larger minimum window size since each chunk will be processed in a relatively short amount of time and the overhead of starting many jobs for smaller chunks will be considerable. For large batches, however, a smaller minimum window size might be more desireable in order to parallelize more the longer running jobs.

### Input
**Note on paths to the reference panel and genetic maps:** The paths to the reference panel and the genetic maps are constructed by appending a path prefix, the contig name, and a path suffix. For an example path to the reference panel (and index) for chr1 `gs://bucket/to/panel/reference_panel_chr1_merged.bcf(.csi)` the following values would have to be set:
```
reference_panel_prefix = "gs://bucket/to/panel/reference_panel_"
reference_panel_suffix = "_merged.bcf"
reference_panel_index_suffix = ".csi"
contig_name_in_reference_panel = "chr1"
```

- **Array[String] contig_regions**: Defines dinstinct intervals that should be chunked up. Usually, these intervals would consist of whole chromosomes (e.g. `["chr1", "chr2", ...]`). However, for regions like the pseudo-autosomal regions (PAR) of chrX, it might be desireable to split a chromosome into multiple intervals, such as `["chr1", "chr2", ..., "chr22", "chrX:1-2781479", "chrX:2781480-155701382", "chrX:155701383-156030895"]`.
- **Array[String] contig_names_in_reference_panel**: In order to find the correct paths for the reference panel it is necessary to define the contig names that will be inserted between the reference panel perfix and suffix. For the above example this array might look like this: `["chr1", "chr2", ..., "chr22", "chrX", "chrX", "chrX"]`.
- **Array[String] contig_names_in_genetic_maps**: Same as `contig_names_in_reference_panel` but for the genetic maps paths. Following the naming of the genetic maps included in GLIMPSE2 this array would look like this: `["chr1", "chr2", ..., "chr22", "chrX_par1", "chrX", "chrX_par2"]`.
- **String reference_panel_prefix**: See note on paths to the reference panel and genetic maps.
- **String reference_panel_suffix**: See note on paths to the reference panel and genetic maps.
- **String reference_panel_index_suffix**: See note on paths to the reference panel and genetic maps.
- **String genetic_map_path_prefix**: See note on paths to the reference panel and genetic maps.
- **String genetic_map_path_suffix**: See note on paths to the reference panel and genetic maps.
- **Int? seed**: Optional integer seed for the generation of chunks
- **Int? min_window_cm**: Optional minimum window size in [Centimorgan](https://en.wikipedia.org/wiki/Centimorgan). See note on chunk sizes above.
- **Int preemtible = 1**: Number of preemptible attempts
- **File? monitoring_script**: Optional path to monitoring script. If ommitted, no monitoring will occur and the `split_reference_monitoring** output will not be available.

### Output
- **Array[File] chunks**: One `chunks_contigindex_{CONTIGINDEX}.txt` file per region as defined in the `contig_regions` input that each include the definitions of the chunks in that region.
- **Array[File] split_reference_chunks**: All binary representations of the reference panel for each chunk in each contig region. Each file is named `reference_panel_contigindex_${CONTIGINDEX}_chunkindex_${CHUNKINDEX}` with `CONTIGINDEX` and `CHUNKINDEX` being 4-digit zero-based indices with leading zeros in order to simplify the correct ordering of intervals.
- **File? monitoring**: A monitoring log if the `monitoring_script` input is set, otherwise null.

## Glimpse2Imputation

This workflow performs the actual imputation using the reference panel chunks generated by GlimpseSplitReference. Each chunk is processed in parallel, subsequently all chunks are being ligated into a single VCF across all regions defined in the `contig_regions` input in GlimpseSplitReference.

### Input
- **File reference_chunks**: File with paths to the `split_reference_chunks` output generated by the GlimpseSplitReference workflow, one file per line. It is necessary to pass them as a list of files because Terra does not like input arrays with 500+ items.
- **File input_vcf**: VCF to be imputed, single sample or multi sample. Sites not present in the reference panel will be ignored, as are sites present in the reference panel and not in the input VCF.
- **File input_vcf_index**: Index to `input_vcf`.
- **File ref_dict**: By default, GLIMPSE2 only adds the contig names defined by the `contig_regions` input in GlimpseSplitReference to the VCF header's sequence dictionary. In order to make the file compatible with downstream tools the sequence dictionary will be replaced with this input.
- **Int preemtible = 1**: Number of preemptible attempts
- **File? monitoring_script**: Optional path to monitoring script. If ommitted, no monitoring will occur and the `split_reference_monitoring** output will not be available.

### Output

- **File imputed_vcf**: Single imputed VCF that covers all regions defined in the `contig_regions` input in GlimpseSplitReference. The name of the file is the basename of `input_vcf` with `.imputed.vcf.gz` added.
- **File imputed_vcf_index**: Index for `imputed_vcf`.
- **Array[File?] glimpse_phase_monitoring**: A monitoring log for each parallelized chunk if the `monitoring_script` input is set, otherwise null.
- **File? glimpse_ligate_monitoring**: A monitoring log for the ligate task if the `monitoring_script` input is set, otherwise null.