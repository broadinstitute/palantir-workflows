# CircleCI 2.1 configuration file
#
#
version: 2.1
executors:
  womtool-executor:
    docker:
      # specify the version you desire here
      - image: broadinstitute/womtool:47-b36d920
        entrypoint: /bin/bash
    working_directory: ~/palantir-workflows
    environment: WOMTOOL_JAR=/app/womtool.jar

  cromwell-executor:
    docker:
      - image: broadinstitute/cromwell:47-b36d920
        entrypoint: /bin/bash
    working_directory: ~/palantir-workflows
    environment: CROMWELL_JAR=/app/cromwell.jar

commands:
  get-cromwell-jar:
    description: "Download cromwell jar"
    steps:
      - run: wget https://github.com/broadinstitute/cromwell/releases/download/47/cromwell-47.jar


jobs:
  validate:
    executor: womtool-executor
    steps:
      - checkout
      - run: apt-get update
      - run: apt-get install -y make
      - run: make validate

#  test:
#    machine: true
#    environment:
#      CROMWELL_JAR=/home/circleci/project/cromwell-47.jar
#    steps:
#      - checkout
#      - get-cromwell-jar
#      - run: make test

  test:
    executor: cromwell-executor
    steps:
      - checkout
      - setup_remote_docker
      - run: apt-get update
      - run: apt-get install -y make
      - run: curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
      - run: apt-get install lsb-core
      - run: add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
      - run: apt-get install -y docker-ce
      - run: make test

workflows:
  version: 2
  validate-and-test:
    jobs:
      - validate
      - test:
          requires:
            - validate