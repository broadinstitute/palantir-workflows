
# Duplex Consensus Liquid Biopsy Pipeline

This pipeline produces variant calls (SNP and indels) from bams that use duplex UMIs.


## How to run

There are two stages to creating variants from tumor, or tumor/normal paired bam.  The first stage is to create the duplex consensus called bam.  This is performed by the GenerateDuplexConsensusBams workflow.  

The second stage is to call variants using MakeCallsFromConsensus.

There is a third, optional stage which is to evaluate the performance of the pipeline using BenchmarkLiquidBiopsy.


### GenerateDuplexConsensusBams

This workflow generates a duplex consensus bam from a bam that has duplex UMIs.

### MakeCallsFromConsensus

This workflow generates variant calls from a duplex bam.  Can be run in tumor only, or tumor/normal mode.
If the tumor/normal pair do not match CrossCheckFingerprints will fail and the entire workflow will fail.

### BenchmarkLiquidBiopsy

If a truth vcf is available, this workflow can be used to evaluate the sensitivity and false positive rate of the
results generated by the GenerateDuplexConsensusBams workflow.

## Inputs

### Workspace Data

- allowable_umi_distance - allowable number of edits between UMIs allowed by GroupReadsByUmi (recommended: 1)
- blastdb_nhr - Reference resource file, necessary for Blast inside the mapping filter
- blastdb_nin - Reference resource file, necessary for Blast inside the mapping filter
- blastdb_nsq - Reference resource file, necessary for Blast inside the mapping filter
- blastn_path - Path in docker for blastn
- bwa_path - Path to bwa in docker
- calc_fs_script - Path to R script used to calculate 
- compression_level - Compression level to use for bams (recommended: 2)
- data_sources_tar_gz - Funcotator data sources
- dbsnp - dbSNP vcf resource
- dbsnp_index - index of dbsnp
- generate_plots_rscript
- gnomad - VCF file containing gnomad allele fractions
- gnomad_index - Index of gnomad
- haplotype_database - Haplotype database used for fingerprinting sample
- known_indels - Resource file of known indels
- known_indels_index - Index of known_indels
- reference* - Reference resource files
- reference_version - Version of reference (recommended: hg19)
- scatter_count - Number of ways to scatter variant calling (recommended: 5)

## Outputs

- duplex_family_sizes - Metrics file produced by fgbio CollectDuplexSeqMetrics.  Contains read counts for all family sizes found.
- duplex_output_bam - Duplex consensus called bam to be used for variant calls.
- duplex_output_bam_index - Index of duplex consensus called bam.
- duplex_per_target_selection_metrics - Per target selection metrics on the duplex bam
- duplex_selection_metrics - Summary selection metrics on the duplex bam
- duplex_theoretical_sensitivity - Estimates of sensitivity using current bam at various allele fractions.  *Warning: This doesn't work well below 5% AF*
- mean_ab_size - Mean number of majority fragments in a duplex family
- mean_ba_size - Mean number of minority fragments in a duplex family
- mean_duplex_depth - Mean duplex depth
- mean_family_size - Mean family size of duplex fragments
- mean_raw_depth - Mean depth of raw bam
- median_ab_size - Median number of majority fragments in a duplex family
- median_ba_size - Median number of minority fragments in a duplex family
- median_family_size - Median number of fragments in a duplex family
- raw_output_bam - Raw aligned bam 
- raw_output_bam_index - Index of raw_output_bam

### MakeCallsFromConsensus
 
- contamination_table - File containing contamination estimation
- filtered_indel_vcf - File containing both passing and filtered indels
- filtered_indel_vcf_idx - Index file for filtered_indel_vcf
- filtered_snp_vcf - File containing both passing and filtered SNPs
- filtered_snp_vcf_idx - Index file for filtered_snp_vcf
- filtered_vcf - File containing both passing and filtered indels and SNPs
- filtered_vcf_idx - Index for filtered_vcf
- funcotated_indel_maf - Final somatic indel variant calls in MAF file format with annotations
- funcotated_snp_maf - Final somatic SNV variant calls in MAF file format with annotations
- igv_session - IGV session consisting of duplex tumor and normal bam and variant calls
- mean_af - Mean allele fraction of SNVs computed from observed ratio of alt to reference ratio
- n_filtered_indels - Count of filtered indels
- n_filtered_snps - Count of filtered SNPs
- n_passing_indels - Count of passing indels
- n_passing_snps - Count of passing SNPs
- variant_table - Table of SNVs generated with numbers of alt alleles at each site
 

### BenchmarkLiquidBiopsy

- igv_session
This is an IGV session provided to aid in debugging performance issues with the pipeline.  This session contains duplex bams from both the tumor and normal, the variant calls evaluated, the truth-set, and tracks corresponding to true positive (TP), false positive (FP), and false negative (FN).

- results_tsv - Detailed variant level results of benchmark

- summary_tsv - Overall results of benchmark

## Software versions

The recommended docker "us.gcr.io/broad-dsde-methods/liquidbiopsy:0.0.3.5" uses
- GATK 4.1.4.1
- Picard 2.20.8
- fgbio 1.0
- samtools 1.3.1
- bwa mem 0.7.15
- bcftools 1.9



## Time and cost estimates

GenerateDuplexConsensusBams

Size | Cost | Time
---|---|---
40 GB bam | $10-$13 | 125h
20 GB bam | ~$5-$8 | 51h


MakeCallsFromConsensus

Cost | Time
---|---
$0.15 - $0.50 | 0:50m - 1:40m 

BenchmarkLiquidBiopsy

Cost | Time
---|---
$0.05 |  30m

## Contact information

This pipeline was developed by Mark Fleharty, fleharty@broadinstitute.org in DSP Methods.  



